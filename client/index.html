<!-- File: `index.html` -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        const socket = io(); // /socket.io/socket.io.js doit être disponible

        var numJoueur = -1;
        // demande Joueurs (je sais pas comment est appelé cette fonction désolé)
        function demandeJoueurs() {
            console.log('Demande des joueurs');
            socket.emit('joueurs');
        }

        // Pour afficher le nombre de joueurs sur la page
        socket.on('joueurs', nomsJoueurs => {
            console.log(`Noms des joueurs reçus du serveur : ${nomJoueurs}`);
            listeJoueurs.value = nomsJoueurs;
        });

        function entrerDansLaPartie() {
            let nom = nomJ.value;
            console.log("Entrée de "+nom);
            if (nom != "" && nom != " ") socket.emit('entree', nom);
        }


        socket.on('entree', data => {
            console.log("Le serveur confirme mon entrée avec numJoueur="+data.numJoueur);
            numJoueur = data.numJoueur;
            btentree.disabled = true;
            btsortie.disabled = false;
            listeJoueurs.textContent = data.nomsJoueurs;
            numJ.textContent = data.numJoueur;
        });
        socket.on('entreeAutreJoueur', data => {
            console.log("Le serveur confirme l'entrée de "+data.nomJoueur);
            listeJoueurs.textContent = data.nomsJoueurs;
        });

        function quitterLaPartie() {
            let nom = nomJ.value;
            console.log("Sortie de "+nom);
            if (nom != "" && nom != " ") socket.emit('sortie', nom);
        }


        socket.on('sortie', data => {
            console.log("Le serveur confirme ma sortie");
            //console.dir(data);
            numJoueur = -1;
            nomJ.value = "";
            numJ.textContent = "";
            btentree.disabled = false;
            btsortie.disabled = true;
            listeJoueurs.textContent = data.nomsJoueurs;
            messageServeur.textContent = "";
        });
        socket.on('sortieAutreJoueur', data => {
            console.log(`Le serveur confirme la sortie de $(data.nomJoueur) de numéro $(data.numJoueur)`);
            if (numJoueur > data.numJoueur) {
                numJoueur--;
                numJ.textContent = numJoueur;
            }
            listeJoueurs.textContent = data.nomsJoueurs;
        });
        // Envoie du message avec le numJoueur et le texte du message associé
        function envoiMessage(input) {
            console.log("Envoi du message :", input.value)
            socket.emit("message", {'numJoueur':numJoueur, 'texte':input.value});
            input.value = "";

        }

        // Réception d'un message classique et l'ajoute en dessous des autres chat
        socket.on('message', message => {
            console.log("Réception du message :", message);
            chat.innerHTML += `<div class="messages" class = "autre" style="text-align:right">${message}</div> <br>` // ou text-align:right si le messageAutre marche
        });

        socket.on('messageAutre',message => {
            console.log("Réception du message :", message);
            chat.innerHTML += `<div class="messages" class ="moi" style="text-align:left">${message}</div> <br>`
        })



        // Réception du message serveur et affiche sur le chat avec une couleur en fonction du type de message
        socket.on('messageServeur', message => {
            console.log("Message serveur :", message);
            let color = "black";

            if (message.includes("rejoint la partie") ) {
                color = "green";
            } else if (message.includes("quitté la partie")
                || message.includes('Nom de joueur déjà enregistré')
                || message.includes('Nombre de joueurs déjà atteint !')) {
                color = "red";
            }
            chat.innerHTML += `<h3 style="color:${color}; margin:5px 0; text-align:center">${message}</h3>`;
        });
    </script>
</head>
<body>
<div id="affichageGlobal">
    <div id="affichageJeu"></div>

    <div id="lobby">
        <div id="info-joueurs">
            Joueurs : <label id="listeJoueurs"></label><br/>
            <p>Votre numéro : <label id="numJ"></label></p>
            <p>Votre nom <input id="nomJ" type="text" /></p>
            <button type="button" id="btentree" onClick="entrerDansLaPartie()">Entrer dans la partie</button>
            <button type="button" id="btsortie" disabled onClick="quitterLaPartie()">Quitter la partie</button>
        </div>

        <br/>

        <div id="chat"></div>

        <p>Message : <input id="messageEntree" type="text" onChange="envoiMessage(this)" /></p>
    </div>
</div>

<script src="AppD3.js" defer></script>
</body>
</html>
