<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        window.socket = io()
        const socket = window.socket

        let tabJoueurs = [];
        var numJoueur = -1;
        let scoreA_actuel = 0;
        let scoreB_actuel = 0;

        function demandeJoueurs() {
            console.log('Demande des joueurs');
            socket.emit('joueurs');
        }

        socket.on('joueurs', nomsJoueurs => {
            console.log(`Noms des joueurs reçus : ${nomsJoueurs}`);
            listeJoueurs.value = nomsJoueurs;
            tabJoueurs = nomsJoueurs.trim().split(' ');
            mettreAJourNomsScores();
        });
        function mettreAJourNomsScores() {
            // Définir les noms par défaut
            let nomA = "Joueur A";
            let nomB = "Joueur B (En attente)";

            // Si on a des joueurs dans le tableau, on remplace
            if (tabJoueurs && tabJoueurs.length > 0) {
                // Sécurité : on vérifie que le nom n'est pas vide
                if (tabJoueurs[0] && tabJoueurs[0].trim() !== "") {
                    nomA = tabJoueurs[0];
                }
            }

            if (tabJoueurs && tabJoueurs.length > 1) {
                if (tabJoueurs[1] && tabJoueurs[1].trim() !== "") {
                    nomB = tabJoueurs[1];
                }
            }

            // On met à jour l'affichage en gardant le score actuel
            document.getElementById('scoreJoueurA').textContent = `Score ${nomA} : ${scoreA_actuel}`;
            document.getElementById('scoreJoueurB').textContent = `Score ${nomB} : ${scoreB_actuel}`;
        }
        function entrerDansLaPartie() {
            let nom = nomJ.value;
            console.log("Entrée de "+nom);
            if (nom !== "" && nom !== " ") socket.emit('entree', nom);
        }

        socket.on('entree', data => {
            console.log("Entrée confirmée numJoueur="+data.numJoueur);
            numJoueur = data.numJoueur;
            btentree.disabled = true;
            btsortie.disabled = false;
            listeJoueurs.textContent = data.nomsJoueurs;
            numJ.textContent = data.numJoueur;
            tabJoueurs = data.nomsJoueurs.trim().split(' ').filter(Boolean);
            mettreAJourNomsScores();
        });

        socket.on('entreeAutreJoueur', data => {
            console.log("Entrée autre joueur: "+data.nomJoueur);
            listeJoueurs.textContent = data.nomsJoueurs;
            tabJoueurs = data.nomsJoueurs.trim().split(' ').filter(Boolean);
            mettreAJourNomsScores();
        });

        function quitterLaPartie() {
            let nom = nomJ.value;
            console.log("Sortie de "+nom);
            if (nom != "" && nom != " ") socket.emit('sortie', nom);
        }

        socket.on('sortie', data => {
            console.log("Sortie confirmée");
            numJoueur = -1;
            nomJ.value = "";
            numJ.textContent = "";
            btentree.disabled = false;
            btsortie.disabled = true;
            listeJoueurs.textContent = data.nomsJoueurs;

            // Mise à jour de la variable tableau
            tabJoueurs = data.nomsJoueurs.trim().split(' ').filter(Boolean);
            mettreAJourNomsScores();
        });

        socket.on('sortieAutreJoueur', data => {
            console.log(`Sortie autre joueur: ${data.nomJoueur}`);
            if (numJoueur > data.numJoueur) {
                numJoueur--;
                numJ.textContent = numJoueur;
            }
            listeJoueurs.textContent = data.nomsJoueurs;

            // Mise à jour de la variable tableau
            tabJoueurs = data.nomsJoueurs.trim().split(' ').filter(Boolean);
            mettreAJourNomsScores();
        });

        function envoiMessage(input) {
            console.log("Envoi message :", input.value)
            socket.emit("message", {'numJoueur':numJoueur, 'texte':input.value});
            input.value = "";
        }

        function NouvellePartie() {
            socket.emit('CommencerPartie')
            btNouvellePartie.hidden = true
            console.log("Début Nouvelle Partie")
        }

        socket.on('NouvellePartie', () => {
            btNouvellePartie.hidden = false
            console.log("Bouton Nouvelle Partie visible")
        })

        // Fonctions du chat

        function getHeureActuelle() {
            const now = new Date();
            const heures = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${heures}:${minutes}`;
        }

        function afficherMessageErreur(message) {
            ajouterMessageChat("⚠️ " + message, 'system');
        }

        function ajouterMessageChat(message, type = 'system', pseudo = null) {
            const chat = document.getElementById('chat');

            // Si c'est un message reçu, on ajoute le petit label pseudo avant la bulle
            if (type === 'received' && pseudo) {
                const pseudoDiv = document.createElement('div');
                pseudoDiv.className = 'pseudo-label';
                pseudoDiv.textContent = pseudo;
                chat.appendChild(pseudoDiv);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `messages ${type}`;

            if (type === 'system') {
                messageDiv.textContent = message;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">${message}</div>
                    <div class="message-time">${getHeureActuelle()}</div>
                `;
            }

            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }

        // Socket listeners Chat

        socket.on('messageServeur', message => {
            const errs = ['déjà enregistré', 'déjà atteint', 'entrer dans la partie', 'Joueur inconnu'];
            // Simple filtre pour savoir si c'est une erreur critique ou une info mais visuellement, on peut tout mettre en 'system'
            ajouterMessageChat(message, 'system');
        });

        // Mon message
        socket.on('message', message => {
            // Format serveur: "Moi : MonTexte"
            // On découpe pour ne garder que le texte
            const parts = message.split(' : ');
            const contenu = parts.slice(1).join(' : ');
            ajouterMessageChat(contenu, 'sent');
        });

        // Message des autres
        socket.on('messageAutre', message => {
            // Format serveur: "L'autre : SonTexte"
            const messageASplit = message.split(' : ');
            const pseudo = messageASplit[0];
            const contenu = messageASplit.slice(1).join(' : ');
            ajouterMessageChat(contenu, 'received', pseudo);


            window.addEventListener("beforeunload", function (event) {
                socket.emit('sortie', nomJ.value);
            });
        
        });
        socket.on('majScoreA', score => {
            // On vérifie si on a un nom, sinon on met "Joueur A" par défaut
            scoreB_actuel = score;
            mettreAJourNomsScores();
        });

        socket.on('majScoreB', score => {
            scoreA_actuel = score;
            mettreAJourNomsScores();
        });

        socket.on('FinDePartie', (resultats) => {
            // Arrêter les interactions
            alert(`PARTIE TERMINÉE !\n\nVainqueur : ${resultats.vainqueur}\n\nScore A : ${resultats.scoreA}\nScore B : ${resultats.scoreB}`);

            // Afficher dans le chat
            ajouterMessageChat(`VICTOIRE DE ${resultats.vainqueur} !`, "system");

            // Faire réapparaître le bouton pour relancer
            btNouvellePartie.hidden = false;
        });


        // Quand le serveur s'arrête (ou redémarre)
        socket.on("disconnect", (reason) => {
            console.log("Connexion au serveur perdue !");
            ajouterMessageChat("Connexion perdue...", "system");
            socket.emit('ArrêterPartie')
        });

        // Quand le serveur revient (Socket.io se reconnecte tout seul)
        socket.on("connect", () => {
            console.log("Connexion retrouvée !");

            if (numJoueur !== -1) {
                ajouterMessageChat("Serveur redémarré. Veuillez vous reconnecter.", "system");
                // Force le rechargement de la page pour remettre tout propre
                setTimeout(() => location.reload(), 2000);
            }
        });
    </script>
</head>
<body>
<div id="affichageGlobal">
    <div id="affichageJeu"></div>

    <div id="lobby">
        <div id="info-joueurs">
            Joueurs : <label id="listeJoueurs"></label><br/>
            <p>Votre numéro : <label id="numJ"></label></p>
            <p><input id="nomJ" type="text" placeholder="Écrivez votre nom..."/></p>
            <button type="button" id="btentree" onClick="entrerDansLaPartie()">Entrer dans la partie</button>
            <button type="button" id="btsortie" disabled onClick="quitterLaPartie()">Quitter la partie</button>
            <br><br>
            <button type="button" id="btNouvellePartie" hidden onclick="NouvellePartie()" > Démarrer Partie</button>
        </div>

        <div id="chat"></div>

        <p>Message : <input id="messageEntree" type="text" onChange="envoiMessage(this)" placeholder="Écrivez votre message..." /></p>
    </div>

    <div id="scoreJoueurs">
        <div id="scoreJoueurB">...</div>
        <div id="scoreJoueurA">...</div>
        <div id="AffichageScore"></div>
    </div>
    <div id = "infoLivre">Aucun livre</div>
</div>

<script src="AppD3.js" defer></script>
</body>
</html>
